# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3

      # Runs a single command using the runners shell
      - name: List /etc
        run: |
          find /etc -ls || :

      - name: Show environment
        run: env | sort

      - name: Show Docker config
        run: cat /etc/docker/daemon.json

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v2

      - name: Inspect builder
        run: |
          echo "Name:      ${{ steps.buildx.outputs.name }}"
          echo "Endpoint:  ${{ steps.buildx.outputs.endpoint }}"
          echo "Status:    ${{ steps.buildx.outputs.status }}"
          echo "Flags:     ${{ steps.buildx.outputs.flags }}"
          echo "Platforms: ${{ steps.buildx.outputs.platforms }}"

      - name: Show environment
        run: env | sort

      - name: Show Docker config
        run: cat /etc/docker/daemon.json

# https://github.com/docker/build-push-action/blob/master/docs/advanced/cache.md#local-cache
      - name: Cache Docker layers a
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx/a
          key: buildx-a-${{ github.sha }}
          restore-keys: |
            buildx-a-

      - name: Cache Docker layers b
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx/b
          key: buildx-b-${{ github.sha }}
          restore-keys: |
            buildx-b-

      - name: Build docker-compose
        run: docker compose build

      # Temp fix
      # https://github.com/docker/build-push-action/issues/252
      # https://github.com/moby/buildkit/issues/1896
      - name: Move cache a
        run: |
          rm -rf /tmp/.buildx/a
          mv /tmp/.buildx/a-new /tmp/.buildx/a
      - name: Move cache b
        run: |
          rm -rf /tmp/.buildx/b
          mv /tmp/.buildx/b-new /tmp/.buildx/b
